name: UCICD Resource Allocator

# This workflow ensures that the proper number of special labeled runners
# are connected to this repository. It runs periodically and checks
# the runner configuration against the desired state.
#
# If runners are missing, it will allocate machines from a pool of
# pre-provisioned machines that are already ready and waiting.

on:
  push:
    paths:
      - '.github/workflows/ucicd-resource-allocator.yml'
      - 'build_tools/ucicd_resource_allocator.py'
      - 'build_tools/ucicd_runner_config.json'
      - 'build_tools/tests/test_ucicd_resource_allocator.py'

  schedule:
    # Run every hour
    - cron: '0 * * * *'

  workflow_dispatch:

env:
  # Configuration file for runner requirements
  RUNNER_CONFIG_FILE: "build_tools/ucicd_runner_config.json"

jobs:
  test-allocator:
    name: Test Resource Allocator
    runs-on: arc-lnx-pub
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests

      - name: Run tests
        run: |
          set -euo pipefail

          echo "=== Running UCICD Resource Allocator Tests ==="
          python -m pytest build_tools/tests/test_ucicd_resource_allocator.py -v

      - name: Run allocator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LNX_SSH_PASS: ${{ secrets.LNX_SSH_PASS }}
          WIN_SSH_PASS: ${{ secrets.WIN_SSH_PASS }}
        run: |
          set -euo pipefail

          echo "=== UCICD Resource Allocator ==="
          echo "Repository: ${{ github.repository }}"
          echo ""

          python build_tools/ucicd_resource_allocator.py \
            --config "${{ env.RUNNER_CONFIG_FILE }}" \
            --repository "${{ github.repository }}"

      - name: Summary
        if: always()
        run: |
          echo "## UCICD Resource Allocator Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the job logs for detailed test results." >> $GITHUB_STEP_SUMMARY
