name: OrchestrAI - Bump PR
run-name: "OrchestrAI Bump PR - Run ${{ inputs.run_id }}${{ inputs.platform && format(' ({0})', inputs.platform) || '' }}"

# This workflow is triggered by poll-therock-orchestrai.yml when a new bump PR
# is discovered from ROCm/TheRock. It uses the reusable-trigger-orchestrai.yml
# workflow to trigger and poll Jenkins jobs.
#
# For bump PRs, we pass the run_id and Jenkins uses install_rocm_from_artifacts.py
# to download artifacts directly from the GitHub Actions run.
#
# This workflow handles all platforms internally. If no platform is specified,
# it will run tests for both linux and windows. The platform input can be used
# to filter to a specific platform when needed.

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'GitHub Actions workflow run ID from ROCm/TheRock'
        required: true
        type: string
      run_url:
        description: 'URL to the GitHub Actions workflow run'
        required: false
        type: string
        default: ''
      run_title:
        description: 'Title/description of the workflow run'
        required: false
        type: string
        default: ''
      run_conclusion:
        description: 'Conclusion of the workflow run (success/failure)'
        required: false
        type: string
        default: ''
      head_sha:
        description: 'Git commit SHA from TheRock'
        required: false
        type: string
        default: ''
      platform:
        description: 'Platform filter (leave empty for all platforms)'
        required: false
        type: string
        default: ''
      pr_number:
        description: 'PR number to post results comment to'
        required: false
        type: string
        default: ''
      pr_repo:
        description: 'Repository for PR comment (owner/repo format)'
        required: false
        type: string
        default: 'ROCm/TheRock'

jobs:
  trigger-orchestrai:
    name: Trigger OrchestrAI for Bump PR
    uses: ./.github/workflows/reusable-trigger-orchestrai.yml
    with:
      platform: ${{ inputs.platform }}
      run_id: ${{ inputs.run_id }}
      head_sha: ${{ inputs.head_sha }}
      post_pr_comment: ${{ inputs.pr_number != '' }}
      pr_number: ${{ inputs.pr_number }}
      pr_repo: ${{ inputs.pr_repo }}
    secrets: inherit

  summary:
    name: Bump PR Summary
    needs: trigger-orchestrai
    if: always()
    runs-on: arc-lnx-pub
    steps:
      - name: Write Bump PR Summary
        run: |
          echo "## OrchestrAI - Bump PR Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ inputs.run_id }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.run_url }}" ]; then
            echo "**TheRock Run:** [${{ inputs.run_id }}](${{ inputs.run_url }})" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ inputs.run_title }}" ]; then
            echo "**Title:** ${{ inputs.run_title }}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ inputs.run_conclusion }}" ]; then
            echo "**TheRock Conclusion:** ${{ inputs.run_conclusion }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**OrchestrAI Result:** ${{ needs.trigger-orchestrai.result }}" >> $GITHUB_STEP_SUMMARY
